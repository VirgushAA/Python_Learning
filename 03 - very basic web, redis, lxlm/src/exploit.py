from lxml import etree
from lxml import html


def prettyprint(element, **kwargs):
    xml = etree.tostring(element, pretty_print=True, **kwargs)
    print(xml.decode(), end='')


def title_change(element):
    title = next(element.iter('title'))
    title.text = 'Evil Corp - Stealing your money every day'


def hacked_announcement(element):
    name: str = ''
    pronoun: str = ''
    person = element.findall('.//span[@class]')
    for atr in person:
        if atr.get('class') == 'pronoun':
            name = atr.tail
            pronoun = atr.text

    body = next(element.iter('body'))
    msg = etree.SubElement(body, 'h1')
    msg.text = pronoun + name + ', you are hacked!'


def insert_element(element, inserted):
    body = next(element.iter('body'))
    body.append(inserted)


def replace_link(element):
    link = next(element.iter('a'))
    link.set('href', 'https://mrrobot.fandom.com/wiki/Fsociety')
    link.text = 'Fsociety'


if __name__ == '__main__':
    script = etree.fromstring('''
        <script>
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load', 
            function() { 
                var f = document.querySelector("form");
                f.setAttribute("onsubmit", "hacked()");
            },
            false
        );
        </script>
    ''')
    evil = html.parse('../materials/evilcorp.html')

    title_change(evil)
    hacked_announcement(evil)
    insert_element(evil, script)
    replace_link(evil)

    evil.write('../materials/evilcorp_hacked.html', pretty_print=True)
